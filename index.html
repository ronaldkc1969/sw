// グラフを更新して描画する関数（氏名ごとに合算）
function updateChart() {
  if (records.length === 0) {
    if (studyChart) {
      studyChart.destroy();
      studyChart = null;
    }
    document.getElementById("summary").textContent = "";
    return;
  }

  // 名前ごとに合計（minutesを加算）
  const byName = {};
  records.forEach(r => {
    if (!byName[r.name]) {
      byName[r.name] = { name: r.name, minutes: 0 };
    }
    byName[r.name].minutes += r.minutes;
  });

  // 表示用に配列化＆ソート（名前順）
  const aggregated = Object.values(byName).sort((a, b) =>
    a.name.localeCompare(b.name, "ja")
  );

  const labels = aggregated.map(r => r.name);
  const data = aggregated.map(r => Math.round((r.minutes / 60) * 10) / 10); // 時間
  const backgroundColors = aggregated.map(r => colorMap[r.name]);

  // 既存チャートがあれば破棄
  if (studyChart) {
    studyChart.destroy();
  }

  studyChart = new Chart(ctx, { // [web:15]
    type: "bar",
     {
      labels: labels,
      datasets: [{
        label: "勉強時間（時間）",
         data,
        backgroundColor: backgroundColors,
        borderColor: backgroundColors.map(c => c.replace("0.7", "1")),
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        x: {
          grid: {
            // 氏名ごと1本なので、シンプルに薄い線
            color: "rgba(0,0,0,0.1)"
          }
        },
        y: {
          beginAtZero: true,
          title: {
            display: true,
            text: "時間"
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: "やるかやらないかではなく、やるかやるかもっとやるか"
        },
        legend: {
          display: false
        },
        tooltip: {
          callbacks: {
            label: (context) => {
              const rec = aggregated[context.dataIndex];
              const h = Math.floor(rec.minutes / 60);
              const m = rec.minutes % 60;
              return `${rec.name}: ${h}時間${m}分`;
            }
          }
        }
      }
    }
  });

  // 合計時間（全員分の合計）はこれまで通り
  const totalMinutes = records.reduce((sum, r) => sum + r.minutes, 0);
  const totalH = Math.floor(totalMinutes / 60);
  const totalM = totalMinutes % 60;
  document.getElementById("summary").textContent =
    `1月合計勉強時間（全員）：${totalH}時間${totalM}分`;
}
